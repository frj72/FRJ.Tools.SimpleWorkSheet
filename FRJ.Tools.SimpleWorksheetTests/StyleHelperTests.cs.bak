using DocumentFormat.OpenXml.Spreadsheet;
using FRJ.Tools.SimpleWorkSheet.Components.Book;
using FRJ.Tools.SimpleWorkSheet.Components.Sheet;
using FRJ.Tools.SimpleWorkSheet.Components.SimpleCell;
using FRJ.Tools.SimpleWorkSheet.LowLevel;
using Xunit;

namespace FRJ.Tools.SimpleWorksheetTests;

public class StyleHelperTests
{
    [Fact]
    public void CollectStyles_WithEmptyWorkBook_DoesNotAddStyles()
    {
        var workBook = new WorkBook("Test", []);
        var styleHelper = new StyleHelper();

        styleHelper.CollectStyles(workBook);

        var stylesheet = styleHelper.GenerateStylesheet();
        Assert.NotNull(stylesheet);
        Assert.Equal(1u, stylesheet.CellFormats.Count);
    }

    [Fact]
    public void CollectStyles_WithSingleCellDefaultStyle_AddsOneStyle()
    {
        var sheet = new WorkSheet("Sheet1");
        sheet.AddCell(new(0, 0), "Test", null);
        var workBook = new WorkBook("Test", [sheet]);
        var styleHelper = new StyleHelper();

        styleHelper.CollectStyles(workBook);

        var stylesheet = styleHelper.GenerateStylesheet();
        Assert.Equal(2u, stylesheet.CellFormats.Count);
    }

    [Fact]
    public void CollectStyles_WithDifferentFillColors_AddsMultipleFills()
    {
        var sheet = new WorkSheet("Sheet1");
        sheet.AddCell(new(0, 0), "Red", builder => builder.WithColor("FF0000"));
        sheet.AddCell(new(1, 0), "Blue", builder => builder.WithColor("0000FF"));
        var workBook = new WorkBook("Test", [sheet]);
        var styleHelper = new StyleHelper();

        styleHelper.CollectStyles(workBook);

        var stylesheet = styleHelper.GenerateStylesheet();
        Assert.True(stylesheet.Fills.Count >= 3);
    }

    [Fact]
    public void CollectStyles_WithBoldFont_AddsFont()
    {
        var sheet = new WorkSheet("Sheet1");
        sheet.AddCell(new(0, 0), "Bold", builder => builder.WithFont(f => f.Bold()));
        var workBook = new WorkBook("Test", [sheet]);
        var styleHelper = new StyleHelper();

        styleHelper.CollectStyles(workBook);

        var stylesheet = styleHelper.GenerateStylesheet();
        Assert.True(stylesheet.Fonts.Count >= 2);
    }

    [Fact]
    public void CollectStyles_WithBorders_AddsBorders()
    {
        var sheet = new WorkSheet("Sheet1");
        var borders = CellBorders.Create(
            CellBorder.Create("000000", CellBorderStyle.Thin),
            null, null, null);
        sheet.AddCell(new(0, 0), "Bordered", builder => builder.WithBorders(borders));
        var workBook = new WorkBook("Test", [sheet]);
        var styleHelper = new StyleHelper();

        styleHelper.CollectStyles(workBook);

        var stylesheet = styleHelper.GenerateStylesheet();
        Assert.True(stylesheet.Borders.Count >= 2);
    }

    [Fact]
    public void CollectStyles_WithDateCell_AddsNumberFormat()
    {
        var sheet = new WorkSheet("Sheet1");
        sheet.AddCell(new(0, 0), DateTime.Now, null);
        var workBook = new WorkBook("Test", [sheet]);
        var styleHelper = new StyleHelper();

        styleHelper.CollectStyles(workBook);

        var stylesheet = styleHelper.GenerateStylesheet();
        Assert.NotNull(stylesheet.NumberingFormats);
    }

    [Fact]
    public void CollectStyles_WithHorizontalAlignment_AddsAlignment()
    {
        var sheet = new WorkSheet("Sheet1");
        sheet.AddCell(new(0, 0), "Center", builder => builder.WithStyle(s => s.WithHorizontalAlignment(HorizontalAlignment.Center)));
        var workBook = new WorkBook("Test", [sheet]);
        var styleHelper = new StyleHelper();

        styleHelper.CollectStyles(workBook);

        var stylesheet = styleHelper.GenerateStylesheet();
        Assert.Equal(2u, stylesheet.CellFormats.Count);
    }

    [Fact]
    public void GenerateStylesheet_WithNoCollectedStyles_ReturnsValidStylesheet()
    {
        var styleHelper = new StyleHelper();

        var stylesheet = styleHelper.GenerateStylesheet();

        Assert.NotNull(stylesheet);
        Assert.NotNull(stylesheet.Fonts);
        Assert.NotNull(stylesheet.Fills);
        Assert.NotNull(stylesheet.Borders);
        Assert.NotNull(stylesheet.CellFormats);
        Assert.Equal(1u, stylesheet.Fonts.Count);
        Assert.Equal(2u, stylesheet.Fills.Count);
        Assert.Equal(1u, stylesheet.Borders.Count);
        Assert.Equal(1u, stylesheet.CellFormats.Count);
    }

    [Fact]
    public void GetStyleIndex_WithExistingStyle_ReturnsValidIndex()
    {
        var sheet = new WorkSheet("Sheet1");
        var cell = sheet.AddCell(new(0, 0), "Test", builder => builder.WithColor("FF0000"));
        var workBook = new WorkBook("Test", [sheet]);
        var styleHelper = new StyleHelper();

        styleHelper.CollectStyles(workBook);

        var index = styleHelper.GetStyleIndex(cell);

        Assert.True(index >= 1);
    }
}